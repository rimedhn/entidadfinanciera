<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Reporte de Jugada</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background-color: #f9f9f9;
    }
    h1 {
      text-align: center;
      color: #333;
    }
    .container {
      max-width: 800px;
      margin: 0 auto;
      background: #fff;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .info-section {
      margin-bottom: 20px;
      padding: 15px;
      background-color: #f0f8ff;
      border-left: 4px solid #007bff;
      border-radius: 4px;
    }
    .info-section h2 {
      margin-top: 0;
      color: #007bff;
      font-size: 1.2em;
    }
    .info-row {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid #e0e0e0;
    }
    .info-row:last-child {
      border-bottom: none;
    }
    .info-label {
      font-weight: bold;
      color: #555;
    }
    .info-value {
      color: #333;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 12px;
      text-align: left;
    }
    th {
      background-color: #007bff;
      color: white;
      font-weight: bold;
    }
    tr:nth-child(even) {
      background-color: #f9f9f9;
    }
    tr:hover {
      background-color: #f1f1f1;
    }
    .error {
      color: red;
      text-align: center;
      font-weight: bold;
      padding: 20px;
    }
    .loading {
      text-align: center;
      padding: 20px;
      color: #666;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Reporte de Jugada</h1>
    <div id="content">
      <div class="loading">Cargando datos...</div>
    </div>
  </div>

  <script>
    (function() {
      var contentDiv = document.getElementById("content");
      
      // Get URL parameters
      var urlParams = new URLSearchParams(window.location.search);
      var jugadaKey = urlParams.get("key");
      var user = urlParams.get("user");

      if (!jugadaKey || !user) {
        contentDiv.innerHTML = '<div class="error">Error: Falta parámetro key o user en la URL.</div>';
        return;
      }

      var opensheetUrlJugadas = "https://opensheet.elk.sh/1ZcHPnYe03lLPNb07yTmxCf75ShifXVWbuFTF6kN_vH4/JUGADAS";
      var opensheetUrlDetalles = "https://opensheet.elk.sh/1ZcHPnYe03lLPNb07yTmxCf75ShifXVWbuFTF6kN_vH4/DETALLESJUGADAS";
      var opensheetUrlVentas = "https://opensheet.elk.sh/1ZcHPnYe03lLPNb07yTmxCf75ShifXVWbuFTF6kN_vH4/VENTAS";

      Promise.all([
        fetch(opensheetUrlJugadas).then(resp => resp.json()),
        fetch(opensheetUrlDetalles).then(resp => resp.json()),
        fetch(opensheetUrlVentas).then(resp => resp.json())
      ])
      .then(([jugadas, detalles, ventas]) => {
        // Find the jugada matching the key
        var jugada = jugadas.find(function(j) {
          var jKey = (j.KEY || j.key || "").toString().trim();
          return jKey === jugadaKey;
        });

        if (!jugada) {
          contentDiv.innerHTML = '<div class="error">No se encontró la jugada con key: ' + jugadaKey + '</div>';
          return;
        }

        // Create ventas map
        var ventasMap = new Map();
        ventas.forEach(function(venta) {
          var ventaId = venta.ID || venta.id || "";
          if (ventaId) {
            ventasMap.set(ventaId.toString().trim(), venta);
          }
        });

        // Filter detalles for this jugada and user
        var detallesFiltrados = detalles.filter(function(d) {
          var keyMatches = (d.KEY || d.key || "").toString().trim() === jugadaKey;
          var userMatches = (d.USER || d.user || "").toString().trim() === user;
          
          var ventaId = (d.VENTA || d.venta || "").toString().trim();
          var estadoDetalle = (d.ESTADO || d.estado || "").toString().trim().toUpperCase();
          var detalleActivo = estadoDetalle === "ACTIVO";
          var ventaActiva = false;
          if (ventaId && ventasMap.has(ventaId)) {
            var ventaRecord = ventasMap.get(ventaId);
            var estadoVenta = (ventaRecord.ESTADO || ventaRecord.estado || "").toString().trim().toUpperCase();
            ventaActiva = estadoVenta === "ACTIVO";
          }
          
          return detalleActivo && ventaActiva && keyMatches && userMatches;
        });

        // Build the info section
        var infoHtml = '<div class="info-section">';
        infoHtml += '<h2>Información de la Jugada</h2>';
        infoHtml += '<div class="info-row"><span class="info-label">Key:</span><span class="info-value">' + (jugada.KEY || jugada.key || '') + '</span></div>';
        infoHtml += '<div class="info-row"><span class="info-label">Sorteo:</span><span class="info-value">' + (jugada.SORTEO || jugada.sorteo || '') + '</span></div>';
        infoHtml += '<div class="info-row"><span class="info-label">Fecha:</span><span class="info-value">' + (jugada.FECHA || jugada.fecha || '') + '</span></div>';
        infoHtml += '<div class="info-row"><span class="info-label">Usuario:</span><span class="info-value">' + user + '</span></div>';
        infoHtml += '</div>';

        // Build the table
        var tableHtml = '<table><thead><tr>';
        tableHtml += '<th>Número</th>';
        tableHtml += '<th>Monto</th>';
        tableHtml += '<th>Venta</th>';
        tableHtml += '</tr></thead><tbody>';

        if (detallesFiltrados.length === 0) {
          tableHtml += '<tr><td colspan="3" style="text-align:center;">No hay detalles activos para este usuario y jugada.</td></tr>';
        } else {
          detallesFiltrados.forEach(function(detalle) {
            tableHtml += '<tr>';
            tableHtml += '<td>' + (detalle.NUMERO || detalle.numero || '') + '</td>';
            tableHtml += '<td>' + (detalle.MONTO || detalle.monto || '') + '</td>';
            tableHtml += '<td>' + (detalle.VENTA || detalle.venta || '') + '</td>';
            tableHtml += '</tr>';
          });
        }

        tableHtml += '</tbody></table>';

        contentDiv.innerHTML = infoHtml + tableHtml;
      })
      .catch(function(error) {
        console.error("Error al cargar los datos:", error);
        contentDiv.innerHTML = '<div class="error">Error al cargar los datos. Por favor, intente nuevamente.</div>';
      });
    })();
  </script>
</body>
</html>